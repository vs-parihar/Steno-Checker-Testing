let algn=[];
function opTr(){if(!('trM').classList.add('active');resTr();('rsV').style.display==='flex'){('trI').value.length>0){('trM').classList.remove('active')}}
function cfmAct(a){('trM').classList.remove('active');resTr()}else if(a==='s'){subTr()}}
function resTr(){trIp=0;clearInterval(trTi);('trI').disabled=1;('trA').innerText='Start';('trV').style.display='flex';('trInf').textContent='Ready'}
function togTr(){if(trIp){subTr()}else{stTr(false)}}
function stTr(a=false){const v=parseFloat(('trC').value)||0;trStopW=(v===0);trDur=v*60;trRem=v*60;trElap=0;trIp=1;('trI').value=('trI').focus();('trA').innerText='Submit (Early)';clearInterval(trTi);trTi=setInterval(()=>{if(trStopW)trElap++;else trRem--;let t=trStopW?trElap:trRem,m=Math.floor(t/60),s=t%60;('trI').disabled=1;('chkFull').checked?origTxt:('trI').value);const m=oToks.length,n=uToks.length,d=Array.from({length:m+1},()=>new Float32Array(n+1).fill(1e9)),p=Array.from({length:m+1},()=>new Int8Array(n+1).fill(0));d[0][0]=0; for(let i=0;i<=m;i++)for(let j=0;j<=n;j++){ if(i<m&&d[i+1][j]>d[i][j]+1){d[i+1][j]=d[i][j]+1;p[i+1][j]=1} if(j<n&&d[i][j+1]>d[i][j]+1){d[i][j+1]=d[i][j]+1;p[i][j+1]=2} if(i<m&&j<n){const c=cmpW(oToks[i].t,uToks[j].t);const raw=oToks[i].t===uToks[j].t?0:0.1;if(d[i+1][j+1]>d[i][j]+c+raw){d[i+1][j+1]=d[i][j]+c+raw;p[i+1][j+1]=0}} if(i<m&&j<n-1){const cm=cmpW(oToks[i].t,uToks[j].t+uToks[j+1].t);if(d[i+1][j+2]>d[i][j]+cm+2){d[i+1][j+2]=d[i][j]+cm+2;p[i+1][j+2]=3}} if(i<m-1&&j<n){const cs=cmpW(oToks[i].t+oToks[i+1].t,uToks[j].t);if(d[i+2][j+1]>d[i][j]+cs+2){d[i+2][j+1]=d[i][j]+cs+2;p[i+2][j+1]=4}}} algn=[];let i=m,j=n;while(i>0||j>0){const op=p[i][j];if(op===0){const c=cmpW(oToks[i-1].t,uToks[j-1].t),raw=oToks[i-1].t!==uToks[j-1].t;algn.unshift({t:(c===0&&!raw)?'k':(c===0?'w':'w'),o:oToks[i-1],u:uToks[j-1],i:i-1,j:j-1,w:c});i--;j--} else if(op===1){algn.unshift({t:'m',o:oToks[i-1],i:i-1,j:-1});i--} else if(op===2){algn.unshift({t:'f',u:uToks[j-1],j:j-1,i:-1});j--} else if(op===3){algn.unshift({t:'h',o:oToks[i-1],u:{t:uToks[j-2].t+" "+uToks[j-1].t},i:i-1,j:j-2,msg:'Split',w:0.5});i--;j-=2} else if(op===4){algn.unshift({t:'h',o:{t:oToks[i-2].t+" "+oToks[i-1].t},u:uToks[j-1],i:i-2,j:j-1,msg:'Merge',w:0.5});i-=2;j--}} errs=algn.filter(x=>x.t!=='k').map((e,idx)=>({...e,id:idx}));('rsV').style.display='flex';('resBox').style.display='flex';('resTit').innerHTML=`\<span style="color:${pass?&#39;var(--gr)&#39;:&#39;var(--re)&#39;}&quot;&gt;${pass?'PASSED':'FAILED'}</span>`;('checkV'),sd=exRules.sub==='d',br=s=>s.normalize('NFC').replace(/[\u200B-\u200D\uFEFF]/g,'').replace(/[^\w\u0900-\u097F\u0964|\-]/g,'').toLowerCase();v.innerHTML='';algn.forEach((x,k)=>{let s=document.createElement('span');s.id=`mk-${x.id}`; if(x.t==='k'){s.className='c-ok';s.textContent=x.o.t+' '} else if(x.t==='m'){s.className='c-del';s.textContent=x.o.t+' ';s.onclick=()=>jump(x.id)} else if(x.t==='f'){s.className='c-ins';s.textContent=x.u.t+' ';s.onclick=()=>jump(x.id)} else{if(sd&&x.val>=1&&x.w>=1){s.innerHTML=`&lt;span class=&quot;c-del&quot;&gt;${x.o.t}</span> <span class="c-ins">${x.u.t}&lt;/span&gt; `}else{s.className='c-grp'; if(br(x.o.t)===br(x.u.t)){let o=x.o.t,u=x.u.t,i=0,j=0;while(i<o.length&&i<u.length&&o[i]===u[i])i++;while(j<o.length-i&&j<u.length-i&&o[o.length-1-j]===u[u.length-1-j])j++; let mO=o.slice(i,o.length-j),mU=u.slice(i,u.length-j);s.innerHTML=o.slice(0,i)+(mO?`&lt;span style=&quot;color:var(--ye)&quot;&gt;${mO}</span>`:'')+(mU?`<span style="color:var(--sky)">${mU}&lt;/span&gt;`:'')+o.slice(o.length-j)+' '}else{s.innerHTML=`&lt;span class=&quot;${x.val&gt;=1?&#39;c-sub-f&#39;:&#39;c-sub-h&#39;}&quot;&gt;${x.u.t}<span class="c-cor">(${x.o.t})&lt;/span&gt;&lt;/span&gt; `}}s.onclick=()=>jump(x.id)} v.appendChild(s)})} function renEL(){const l={getCtx(oToks,e.i,2,-1)}</span><span class="e-w {e.t==='m'?e.o.t:e.u.t}{e.val})</span></div>

<div class="row" style="margin-top:2px;justify-content:flex-end">
<button class="op-btn {e.id},1)">F</button><button class="op-btn {e.id},0.5)">H</button><button class="op-btn {e.id},2)">D</button><button class="op-btn {e.id},0)">X</button></div>`;l.appendChild(it)})} function getCtx(tk,idx,c,dir){if(idx&lt;0)return&quot;&quot;;let s=[],cnt=0,curr=idx+dir;while(cnt&lt;c&amp;&amp;curr&gt;=0&amp;&amp;curr&lt;tk.length){if(dir&lt;0)s.unshift(tk[curr].t);else s.push(tk[curr].t);curr+=dir;cnt++}return s.join(&#39; &#39;)} function jump(id){if(id===undefined)return;const e=errs.find(x=&gt;x.id===id);if(!e)return;clrHl(); const el=$(`mk-{id}`)?.scrollIntoView({behavior:&#39;smooth&#39;,block:&#39;center&#39;});[...$('eL').children].forEach(c=\>c.classList.remove('active'));$(`err-${id}`)?.classList.add('active')}
function clrHl(){[...document.querySelectorAll('.ctx-hl')].forEach(e=>e.classList.remove('ctx-hl'))}
function upEr(ev,id,v){ev.stopPropagation();const e=errs.find(x=>x.id===id);if(e){e.ovr=v;reCalc();jump(id)}}
