let trTi=null,trRem=0,trElap=0,trStopW=0,trDur=0,trIp=0,errs=[],oToks=[],uToks=[];
const nrm=(s)=>s.normalize('NFC').replace(/[\u200B-\u200D\uFEFF]/g,'').replace(/[०-९]/g,d=>'०१२३४५६७८९'.indexOf(d)).trim();
const bare=(s)=>nrm(s).toLowerCase().replace(/[.।!?;:,|\-]/g,'');
const getAk=(s)=>{const r=[];const re=/[\u0900-\u097F][\u093C]?[\u094D]?|./g;let m;while((m=re.exec(s))!==null)r.push(m[0]);return r;};
const pKey=(s)=>{let k=bare(s).replace(/[\u093E-\u094C\u0962\u0963]/g,'');k=k.replace(/[\u0901\u0902]/g,'N').replace(/\u094D/g,'');const su=['ना','ता','ती','ओं','ों'];su.forEach(x=>{if(k.endsWith(x))k=k.slice(0,-x.length)});return k;};
const tok=(t)=>{let r=[],re=/\S+/g,m;while((m=re.exec(t))!==null)r.push({t:m[0],s:m.index,e:re.lastIndex});return r;};
const wDist=(a,b)=>{if(a===b)return 0;if(pKey(a)===pKey(b))return 0.2;let d=Array.from({length:a.length+1},()=>[]);for(let i=0;i<=a.length;i++)for(let j=0;j<=b.length;j++){if(i===0)d[i][j]=j;else if(j===0)d[i][j]=i;else d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+(a[i-1]===b[j-1]?0:0.5));}return d[a.length][b.length];};
function opTr(){if(!$('tx').value.trim()&&exMode!=='mock'){alert('Load text first!');return;}if(typeof is!=='undefined'&&is){au.pause();is=0;updatePlBtn();} $('trM').classList.add('active');resTr();$('trA').disabled=0;}
function resTr(){trIp=0;clearInterval(trTi);$('trI').value='';$('trI').disabled=1;$('trA').disabled=0;$('trA').innerText='Start';$('trCD').textContent='00:00';$('trV').style.display='flex';$('rsV').style.display='none';}
function stTr(){const v=parseFloat($('trT').value)||parseFloat($('trC').value)||0;trStopW=(v===0);trDur=v*60;trRem=v*60;trElap=0;trIp=1;$('trI').disabled=0;$('trI').focus();$('trA').innerText='Submit';trTi=setInterval(()=>{if(trStopW)trElap++;else trRem--;let t=trStopW?trElap:trRem,m=Math.floor(t/60),s=t%60;$('trCD').textContent=`${m}:${s<10?'0':''}${s}`;if(!trStopW&&trRem<=0)subTr();},1000);}
function subTr(){clearInterval(trTi);trIp=0;$('trI').disabled=1;const srcT=$('chkFull').checked?origTxt:$('tx').value;oToks=tok(srcT);uToks=tok($('trI').value);const m=oToks.length,n=uToks.length,dp=Array.from({length:m+1},()=>new Float32Array(n+1));
for(let i=1;i<=m;i++)for(let j=1;j<=n;j++){const cost=(bare(oToks[i-1].t)===bare(uToks[j-1].t))?1:(pKey(oToks[i-1].t)===pKey(uToks[j-1].t)?0.8:0);dp[i][j]=Math.max(dp[i-1][j],dp[i][j-1],dp[i-1][j-1]+cost);}
let i=m,j=n;errs=[];while(i>0||j>0){const bo=i>0?bare(oToks[i-1].t):'',bu=j>0?bare(uToks[j-1].t):'';if(i>0&&j>0&&(bo===bu||pKey(bo)===pKey(bu))){const o=nrm(oToks[i-1].t),u=nrm(uToks[j-1].t);errs.unshift({t:o===u?'w':'h',o:oToks[i-1],u:uToks[j-1],i:i-1,j:j-1});i--;j--;}else if(j>0&&(i===0||dp[i][j-1]>=dp[i-1][j])){errs.unshift({t:'f',u:uToks[j-1],j:j-1,i:-1});j--;}else{errs.unshift({t:'m',o:oToks[i-1],i:i-1,j:-1});i--;}}
$('trV').style.display='none';$('rsV').style.display='flex';renCheckV();reCalc();}
function renCheckV(){const v=$('checkV'),r=$('rS'),srcT=$('chkFull').checked?origTxt:$('tx').value;v.innerHTML='';r.innerHTML='';let sIdx=0;oToks.forEach((tok,idx)=>{if(tok.s>sIdx)r.appendChild(document.createTextNode(srcT.slice(sIdx,tok.s)));let sp=document.createElement('span');sp.textContent=tok.t;sp.className='w-n';sp.id=`o-${idx}`;sp.onclick=()=>revClick('o',idx);r.appendChild(sp);sIdx=tok.e;});
errs.forEach((e,k)=>{let sp=document.createElement('span');sp.id=`u-${k}`;sp.onclick=()=>revClick('u',k);if(e.t==='f'){sp.className='c-ins';sp.textContent=e.u.t+' ';}else if(e.t==='m'){sp.className='c-mis';sp.textContent=e.o.t+' ';}else if(e.t==='h'){sp.className='c-sp';sp.textContent=e.u.t+' ';}else{sp.className='w-n';sp.textContent=e.u.t+' ';}v.appendChild(sp);});}
function reCalc(){let tE=0,tot=oToks.length,r=exRules;errs.forEach(e=>{let v=0;if(e.t==='f')v=r.sub==='d'?1:0.5;else if(e.t==='m')v=1;else if(e.t==='h')v=wDist(e.o.t,e.u.t)<=0.5?0.5:1;tE+=v;});const acc=Math.max(0,100-(tE/tot*100)),pass=acc>=(100-parseFloat(r.max));$('resBox').style.display='flex';$('resTit').innerHTML=`<span style="color:${pass?'var(--gr)':'var(--re)'}">${pass?'PASSED':'FAILED'}</span>`;$('resDet').innerHTML=`Errors: <b>${tE.toFixed(1)}</b> / ${tot}<br>Accuracy: <b>${acc.toFixed(1)}%</b>`;}
function revClick(t,idx){let k=t==='o'?errs.findIndex(e=>e.i===idx):idx;if(k!==-1)jump(k);}
function jump(k){const e=errs[k];if(!e)return;[...document.querySelectorAll('.ctx-hl')].forEach(x=>x.classList.remove('ctx-hl'));if(e.i!==-1){$(`o-${e.i}`)?.scrollIntoView({behavior:'smooth',block:'center'});$(`o-${e.i}`)?.classList.add('ctx-hl');}$(`u-${k}`)?.scrollIntoView({behavior:'smooth',block:'center'});$(`u-${k}`)?.classList.add('ctx-hl');}
